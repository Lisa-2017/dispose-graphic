<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>demo2</title>
    <style>
      canvas{
        background-color: #f1f1f1;
      }
    </style>
  </head>

  <body>
    <input type="file" />&ensp;<button>水平翻转</button>
    <br>
    <br>
    <canvas></canvas>
    <script>
      function Filter(context){
        this.context = context;
      }
      Filter.prototype.constructor = Filter;
      Filter.prototype.flipHorizontal = function(startX, startY, w, h){
        // 1.获取图像信息
        let imgdata = this.context.getImageData(0, 0, w, h);
        // 中轴
        let middleAxle = (w * 4) / 2;

        // 2.遍历每一行作为外循环
        for (let rows = 0; rows < h; rows++) {
          // 每行开始的通道位置
          let colsStart = rows * w * 4,
          // 每行结束的通道位置
              colsEnd = (rows + 1) * w * 4 - 4;
          // 每一行中轴所在的位置
          let curMiddleAxle = colsEnd - middleAxle;

          // 3.遍历当前行的列作为内循环,把列的左边像素按照轴对称和右边的像素互换
          for (; colsStart <= curMiddleAxle; colsStart += 4, colsEnd -= 4) {
            // 临时变量
            let tr = imgdata.data[colsStart],
                tg = imgdata.data[colsStart + 1],
                tb = imgdata.data[colsStart + 2],
                ta = imgdata.data[colsStart + 3];
    
            imgdata.data[colsStart] = imgdata.data[colsEnd];
            imgdata.data[colsStart + 1] = imgdata.data[colsEnd + 1];
            imgdata.data[colsStart + 2] = imgdata.data[colsEnd + 2];
            imgdata.data[colsStart + 3] = imgdata.data[colsEnd + 3];
    
            imgdata.data[colsEnd] = tr;
            imgdata.data[colsEnd + 1] = tg;
            imgdata.data[colsEnd + 2] = tb;
            imgdata.data[colsEnd + 3] = ta;
          }
        }

        // 4.把处理后的像素信息放回画布
        this.context.clearRect(startX, startY, w, h);
        this.context.putImageData(imgdata, startX, startY);
      }

      // 绘图配置
      var drawConfig = {
        startX: 0,
        startY: 0,
        drawX: 0,
        drawY: 0
      }

      // 获取画布
      var cvs = document.querySelector("canvas");
      cvs.width = 400;
      cvs.height = 400;

      // 创建用于绘图的图像
      const createImage = function(file) {
        return new Promise(function(res, rej) {
          url = window.URL.createObjectURL(file);
          let img = new Image();
          img.src = url;
          img.onload = function() {
            Object.assign(drawConfig,{
              drawX: img.width,
              drawY: img.height
            })
            res(img);
          };
        });
      };

      // 绘图
      const draw = function(context, file) {
        createImage(file).then(img => {
          context.drawImage(img, drawConfig.startX, drawConfig.startY, drawConfig.drawX, drawConfig.drawY);
        });
      };

      // 画布就绪
      if (cvs.getContext && cvs.getContext("2d")) {
        let ctx = cvs.getContext("2d");
        const filter = new Filter(ctx); // 实例滤镜

        // 打开图片
        document.querySelector("input").addEventListener("change", function() {
          draw(ctx,this.files[0]);
        });

        // 水平翻转
        document.querySelector('button').addEventListener('click',function(){
          filter.flipHorizontal(drawConfig.startX, drawConfig.startY, drawConfig.drawX, drawConfig.drawY);
        })
      }
    </script>
  </body>
</html>
